<!DOCTYPE html>
<html>
<head>
  <title>MLC Scaling Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }
    
    .header {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      padding: 30px;
      margin-bottom: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }
    
    h1 {
      color: #2d3748;
      font-size: 2.5em;
      font-weight: 700;
      margin-bottom: 10px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .subtitle {
      color: #718096;
      font-size: 1.1em;
    }
    
    #status {
      padding: 15px 25px;
      border-radius: 12px;
      font-weight: 600;
      font-size: 1em;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      transition: all 0.3s ease;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.8; }
    }
    
    .connected { 
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      animation: none;
    }
    .disconnected { 
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: white;
      animation: none;
    }
    .connecting { 
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      color: white;
    }
    
    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: white;
      animation: blink 1s infinite;
    }
    
    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    
    .stat-card {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
    }
    
    .stat-label {
      color: #718096;
      font-size: 0.85em;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 8px;
    }
    
    .stat-value {
      color: #2d3748;
      font-size: 2em;
      font-weight: 700;
    }
    
    .stat-unit {
      color: #a0aec0;
      font-size: 0.6em;
      font-weight: 400;
    }
    
    .chart-container {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      padding: 30px;
      margin-bottom: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      transition: transform 0.3s ease;
    }
    
    .chart-container:hover {
      transform: scale(1.01);
    }
    
    .chart-title {
      color: #2d3748;
      font-size: 1.5em;
      font-weight: 700;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .chart-icon {
      font-size: 1.2em;
    }
    
    canvas {
      max-height: 300px;
    }
    
    .footer {
      text-align: center;
      color: rgba(255, 255, 255, 0.8);
      margin-top: 30px;
      font-size: 0.9em;
    }
    
    .control-panel {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      padding: 25px;
      margin-bottom: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }
    
    .control-title {
      color: #2d3748;
      font-size: 1.3em;
      font-weight: 700;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .agent-list {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 15px;
    }
    
    .agent-badge {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 0.9em;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .agent-status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #10b981;
      animation: blink 2s infinite;
    }
    
    .button-group {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }
    
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 10px;
      font-size: 1em;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }
    
    .btn:active {
      transform: translateY(0);
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
    }
    
    .btn-secondary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .chart-container, .stat-card {
      animation: fadeIn 0.5s ease forwards;
    }
    
    .chart-container:nth-child(2) { animation-delay: 0.1s; }
    .chart-container:nth-child(3) { animation-delay: 0.2s; }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>‚ö° Real-Time MLC NUMA Scaling Dashboard</h1>
      <p class="subtitle">Real-time Multi-Machine Benchmark Dashboard</p>
      <div style="margin-top: 15px;">
        <div id="status" class="connecting">
          <span class="status-dot"></span>
          Connecting to server...
        </div>
      </div>
    </div>

    <div class="control-panel">
      <div class="control-title">
        <span>üéÆ</span>
        Remote Control Panel
      </div>
      <div class="agent-list" id="agentList">
        <span style="color: #718096;">No agents connected</span>
      </div>
      <div class="button-group">
        <button class="btn btn-primary" id="runAllBtn" onclick="runAllBenchmarks()" disabled>
          ‚ñ∂Ô∏è Run All Benchmarks
        </button>
        <button class="btn btn-secondary" id="refreshBtn" onclick="refreshAgents()">
          üîÑ Refresh Agents
        </button>
      </div>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">Active Machines</div>
        <div class="stat-value" id="machineCount">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Current Cores</div>
        <div class="stat-value" id="currentCores">-</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Latest KPI</div>
        <div class="stat-value" id="currentBW">-</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Tests Completed</div>
        <div class="stat-value" id="testCount">0</div>
      </div>
    </div>

    <div class="chart-container">
      <div class="chart-title">
        <span class="chart-icon">üìä</span>
        Benchmark Results
      </div>
      <canvas id="bwChart"></canvas>
    </div>

    <div class="footer">
      <p>Real-time multi-machine benchmark monitoring</p>
    </div>
  </div>

<script>

const bwCtx = document.getElementById('bwChart').getContext('2d');
const statusDiv = document.getElementById('status');

let testCount = 0;
let ws;
let controlWs;
let reconnectTimeout;
let machines = new Map(); // Track data per machine
let connectedAgents = [];
let machineColors = [
  'rgb(102, 126, 234)',
  'rgb(239, 68, 68)',
  'rgb(16, 185, 129)',
  'rgb(245, 158, 11)',
  'rgb(139, 92, 246)',
  'rgb(236, 72, 153)'
];

function getColorForMachine(machineId) {
  if (!machines.has(machineId)) {
    const colorIndex = machines.size % machineColors.length;
    machines.set(machineId, {
      color: machineColors[colorIndex],
      lastUpdate: Date.now()
    });
  }
  return machines.get(machineId).color;
}

const chartOptions = {
  responsive: true,
  maintainAspectRatio: true,
  animation: {
    duration: 750,
    easing: 'easeInOutQuart'
  },
  plugins: {
    legend: {
      display: true,
      position: 'top',
      labels: {
        font: {
          size: 14,
          weight: '600'
        }
      }
    },
    tooltip: {
      backgroundColor: 'rgba(0, 0, 0, 0.8)',
      padding: 12,
      titleFont: {
        size: 14,
        weight: '600'
      },
      bodyFont: {
        size: 13
      },
      cornerRadius: 8
    }
  },
  scales: {
    y: {
      beginAtZero: false,
      grid: {
        color: 'rgba(0, 0, 0, 0.05)'
      },
      ticks: {
        font: {
          size: 12
        }
      }
    },
    x: {
      grid: {
        color: 'rgba(0, 0, 0, 0.05)'
      },
      ticks: {
        font: {
          size: 12
        }
      }
    }
  }
};

const bwChart = new Chart(bwCtx, {
  type: 'line',
  data: { 
    labels: [], 
    datasets: []
  },
  options: {
    ...chartOptions,
    scales: {
      ...chartOptions.scales,
      y: {
        ...chartOptions.scales.y,
        title: {
          display: true,
          text: 'KPI Value',
          font: { size: 13, weight: '600' }
        }
      }
    }
  }
});



function getOrCreateDataset(chart, machineId, metricLabel) {
  let dataset = chart.data.datasets.find(ds => ds.label === `${machineId} - ${metricLabel}`);
  
  if (!dataset) {
    const color = getColorForMachine(machineId);
    const rgbaColor = color.replace('rgb', 'rgba').replace(')', ', 0.1)');
    
    dataset = {
      label: `${machineId} - ${metricLabel}`,
      data: [],
      borderColor: color,
      backgroundColor: rgbaColor,
      borderWidth: 3,
      tension: 0.4,
      fill: true,
      pointRadius: 6,
      pointHoverRadius: 8,
      pointBackgroundColor: color,
      pointBorderColor: '#fff',
      pointBorderWidth: 2
    };
    
    chart.data.datasets.push(dataset);
  }
  
  return dataset;
}

function updateStatus(message, className) {
  statusDiv.innerHTML = `<span class="status-dot"></span>${message}`;
  statusDiv.className = className;
}

function updateAgentList(agents) {
  connectedAgents = agents;
  const agentListDiv = document.getElementById('agentList');
  const runAllBtn = document.getElementById('runAllBtn');
  
  if (agents.length === 0) {
    agentListDiv.innerHTML = '<span style="color: #718096;">No agents connected</span>';
    runAllBtn.disabled = true;
  } else {
    agentListDiv.innerHTML = agents.map(agent => 
      `<div class="agent-badge">
        <span class="agent-status-dot"></span>
        ${agent}
      </div>`
    ).join('');
    runAllBtn.disabled = false;
  }
}

function runAllBenchmarks() {
  if (!controlWs || controlWs.readyState !== WebSocket.OPEN) {
    alert('Control connection not established. Please refresh the page.');
    return;
  }
  
  if (connectedAgents.length === 0) {
    alert('No agents connected!');
    return;
  }
  
  console.log('Triggering benchmark on all agents:', connectedAgents);
  controlWs.send(JSON.stringify({
    command: 'run_all'
  }));
  
  updateStatus('Triggered benchmarks on all agents', 'connecting');
}

function refreshAgents() {
  if (controlWs && controlWs.readyState === WebSocket.OPEN) {
    controlWs.send(JSON.stringify({
      command: 'get_agents'
    }));
  }
}

function connectControl() {
  const wsUrl = `ws://${window.location.hostname}:8000/ws/control`;
  console.log('Connecting control channel to:', wsUrl);
  
  controlWs = new WebSocket(wsUrl);
  
  controlWs.onopen = () => {
    console.log('Control WebSocket connected');
    // Request agent list
    controlWs.send(JSON.stringify({ command: 'get_agents' }));
  };
  
  controlWs.onmessage = (event) => {
    try {
      const msg = JSON.parse(event.data);
      if (msg.type === 'agent_list') {
        updateAgentList(msg.agents);
      }
    } catch (e) {
      console.error('Control message error:', e);
    }
  };
  
  controlWs.onclose = () => {
    console.log('Control WebSocket closed, reconnecting...');
    setTimeout(connectControl, 3000);
  };
  
  controlWs.onerror = (error) => {
    console.error('Control WebSocket error:', error);
  };
}

function updateStats(cores, kpi) {
  document.getElementById('machineCount').textContent = machines.size;
  document.getElementById('currentCores').textContent = cores;
  document.getElementById('currentBW').textContent = kpi ? kpi.toFixed(1) : '-';
  document.getElementById('testCount').textContent = testCount;
}

function connect() {
  const wsUrl = `ws://${window.location.hostname}:8000/ws`;
  console.log('Connecting to:', wsUrl);
  
  ws = new WebSocket(wsUrl);
  
  ws.onopen = () => {
    updateStatus('Connected - Running benchmark...', 'connected');
    console.log('WebSocket connected');
  };
  
  ws.onmessage = (event) => {
    try {
      const msg = JSON.parse(event.data);
      
      // Handle agent list updates
      if (msg.type === 'agent_list') {
        updateAgentList(msg.agents);
        return;
      }
      
      // Skip error messages
      if (msg.error) {
        console.warn('Received error:', msg.error);
        return;
      }
      
      // Skip non-benchmark messages
      const kpiValue = msg.requests || msg.bandwidth || msg.kpi;
      if (!msg.cores || !kpiValue) {
        return;
      }
      
      const machineId = msg.machine || msg.host || 'unknown';
      const label = `${machineId}-${msg.cores}c`;
      
      testCount++;
      
      // Update or add label if not exists
      if (!bwChart.data.labels.includes(label)) {
        bwChart.data.labels.push(label);
      }

      // Get or create dataset for this machine
      const bwDataset = getOrCreateDataset(bwChart, machineId, 'KPI');
      
      // Add data point
      bwDataset.data.push(kpiValue);
      
      // Update chart
      bwChart.update('active');
      
      updateStats(msg.cores, kpiValue);
      updateStatus(`Running - ${machineId}: ${msg.cores} cores`, 'connected');
    } catch (e) {
      console.error('Error parsing message:', e);
    }
  };
  
  ws.onclose = () => {
    updateStatus('‚úì Benchmark Completed', 'disconnected');
    console.log('WebSocket closed');
  };
  
  ws.onerror = (error) => {
    updateStatus('Connection error - Check server status', 'disconnected');
    console.error('WebSocket error:', error);
  };
}

// Start connections
connect();
connectControl();
</script>
</body>
</html>

