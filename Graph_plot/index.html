<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NGINX VM Scaling Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
      min-height: 100vh;
      padding: 20px;
      color: #fff;
      overflow-x: hidden;
    }
    
    /* Animated background particles */
    .particles {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 0;
      pointer-events: none;
    }
    
    .particle {
      position: absolute;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      animation: float 20s infinite ease-in-out;
    }
    
    @keyframes float {
      0%, 100% { transform: translateY(0) translateX(0) scale(1); }
      33% { transform: translateY(-100px) translateX(50px) scale(1.2); }
      66% { transform: translateY(-50px) translateX(-50px) scale(0.8); }
    }
    
    .container {
      max-width: 1600px;
      margin: 0 auto;
      position: relative;
      z-index: 1;
    }
    
    /* Header Section */
    .header {
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.15) 0%, rgba(168, 85, 247, 0.15) 100%);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 24px;
      padding: 40px;
      margin-bottom: 30px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
      position: relative;
      overflow: hidden;
    }
    
    .header::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(99, 102, 241, 0.1) 0%, transparent 70%);
      animation: rotate 30s linear infinite;
    }
    
    @keyframes rotate {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    
    h1 {
      font-size: 3em;
      font-weight: 700;
      margin-bottom: 10px;
      background: linear-gradient(135deg, #667eea 0%, #a855f7 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      position: relative;
      z-index: 1;
      text-shadow: 0 0 30px rgba(99, 102, 241, 0.5);
    }
    
    .subtitle {
      color: rgba(255, 255, 255, 0.7);
      font-size: 1.2em;
      font-weight: 300;
      position: relative;
      z-index: 1;
    }
    
    /* Status Bar */
    #status {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 20px 30px;
      background: linear-gradient(135deg, rgba(34, 197, 94, 0.15) 0%, rgba(21, 128, 61, 0.15) 100%);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(34, 197, 94, 0.3);
      border-radius: 16px;
      margin-top: 20px;
      position: relative;
      z-index: 1;
      transition: all 0.3s ease;
    }
    
    #status.disconnected {
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.15) 0%, rgba(185, 28, 28, 0.15) 100%);
      border-color: rgba(239, 68, 68, 0.3);
    }
    
    .status-indicator {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: #22c55e;
      box-shadow: 0 0 20px rgba(34, 197, 94, 0.8);
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.2); opacity: 0.8; }
    }
    
    .status-indicator.disconnected {
      background: #ef4444;
      box-shadow: 0 0 20px rgba(239, 68, 68, 0.8);
      animation: none;
    }
    
    #statusText {
      font-size: 1.1em;
      font-weight: 600;
    }
    
    /* Control Panel */
    .control-panel {
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.12) 0%, rgba(168, 85, 247, 0.12) 100%);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 24px;
      padding: 30px;
      margin-bottom: 30px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
    }
    
    .control-header {
      font-size: 1.5em;
      font-weight: 600;
      margin-bottom: 20px;
      color: #a855f7;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .agent-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 25px;
    }
    
    .agent-card {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      padding: 20px;
      text-align: center;
      transition: all 0.3s ease;
      cursor: pointer;
    }
    
    .agent-card:hover {
      background: rgba(255, 255, 255, 0.1);
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(168, 85, 247, 0.3);
    }
    
    .agent-name {
      font-size: 1.3em;
      font-weight: 600;
      color: #a855f7;
      margin-bottom: 5px;
    }
    
    .agent-status {
      font-size: 0.9em;
      color: rgba(255, 255, 255, 0.6);
    }
    
    .agent-icon {
      width: 50px;
      height: 50px;
      background: linear-gradient(135deg, #667eea 0%, #a855f7 100%);
      border-radius: 50%;
      margin: 0 auto 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5em;
      box-shadow: 0 5px 15px rgba(168, 85, 247, 0.4);
    }
    
    .run-button {
      width: 100%;
      padding: 18px 40px;
      font-size: 1.2em;
      font-weight: 600;
      color: #fff;
      background: linear-gradient(135deg, #667eea 0%, #a855f7 100%);
      border: none;
      border-radius: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 10px 30px rgba(168, 85, 247, 0.4);
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .run-button:hover {
      transform: translateY(-3px);
      box-shadow: 0 15px 40px rgba(168, 85, 247, 0.6);
    }
    
    .run-button:active {
      transform: translateY(-1px);
    }
    
    .run-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    
    /* Chart Container */
    .chart-container {
      background: linear-gradient(135deg, rgba(30, 41, 59, 0.5) 0%, rgba(15, 23, 42, 0.5) 100%);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 24px;
      padding: 40px;
      margin-bottom: 30px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      transition: all 0.3s ease;
    }
    
    .chart-container:hover {
      box-shadow: 0 25px 70px rgba(0, 0, 0, 0.6);
      transform: translateY(-2px);
    }
    
    .chart-title {
      font-size: 1.8em;
      font-weight: 600;
      margin-bottom: 25px;
      color: #a855f7;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .chart-icon {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, #667eea 0%, #a855f7 100%);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2em;
    }
    
    canvas {
      max-height: 500px;
    }
    
    /* Footer */
    .footer {
      text-align: center;
      padding: 30px;
      color: rgba(255, 255, 255, 0.5);
      font-size: 0.9em;
    }
    
    /* Loading Animation */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: #a855f7;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Responsive Design */
    @media (max-width: 768px) {
      h1 {
        font-size: 2em;
      }
      
      .agent-grid {
        grid-template-columns: 1fr;
      }
      
      .chart-container {
        padding: 20px;
      }
    }
  </style>
</head>
<body>
  <!-- Animated background particles -->
  <div class="particles" id="particles"></div>
  
  <div class="container">
    <!-- Header -->
    <div class="header">
      <h1>üöÄ Real-Time NGINX VM Scaling Dashboard</h1>
      <p class="subtitle">Monitor and analyze IOPS performance across multiple systems</p>
      
      <div id="status" class="disconnected">
        <div class="status-indicator disconnected"></div>
        <span id="statusText">Connecting...</span>
      </div>
    </div>
    
    <!-- Control Panel -->
    <div class="control-panel">
      <div class="control-header">
        <span>üéÆ</span>
        <span>Control Center</span>
      </div>
      
      <div id="agentList" class="agent-grid">
        <!-- Agents will be populated here -->
      </div>
      
      <button id="runAllBtn" class="run-button" onclick="runAll()">
        <span id="btnText">üî• Run All Agents</span>
      </button>
    </div>
    
    <!-- Chart Section -->
    <div class="chart-container">
      <div class="chart-title">
        <div class="chart-icon">üìä</div>
        <span>IOPS Performance Chart</span>
      </div>
      <canvas id="bwChart"></canvas>
    </div>
    
    <!-- Footer -->
    <div class="footer">
      <p>Real-Time NGINX VM Scaling Dashboard | Powered by WebSocket & Chart.js</p>
    </div>
  </div>

  <script>
    // Create animated background particles
    function createParticles() {
      const container = document.getElementById('particles');
      for (let i = 0; i < 20; i++) {
        const particle = document.createElement('div');
        particle.className = 'particle';
        particle.style.width = Math.random() * 100 + 20 + 'px';
        particle.style.height = particle.style.width;
        particle.style.left = Math.random() * 100 + '%';
        particle.style.top = Math.random() * 100 + '%';
        particle.style.animationDelay = Math.random() * 20 + 's';
        particle.style.animationDuration = (Math.random() * 10 + 15) + 's';
        container.appendChild(particle);
      }
    }
    createParticles();

    let ws = null;
    let controlWs = null;
    let bwChart = null;
    let testCount = 0;
    let agents = [];

    const chartColors = [
      {
        border: 'rgba(99, 102, 241, 1)',
        bg: 'rgba(99, 102, 241, 0.2)'
      },
      {
        border: 'rgba(168, 85, 247, 1)',
        bg: 'rgba(168, 85, 247, 0.2)'
      },
      {
        border: 'rgba(236, 72, 153, 1)',
        bg: 'rgba(236, 72, 153, 0.2)'
      },
      {
        border: 'rgba(59, 130, 246, 1)',
        bg: 'rgba(59, 130, 246, 0.2)'
      },
      {
        border: 'rgba(16, 185, 129, 1)',
        bg: 'rgba(16, 185, 129, 0.2)'
      }
    ];

    // Chart configuration
    const chartOptions = {
      responsive: true,
      maintainAspectRatio: true,
      animation: {
        duration: 750,
        easing: 'easeInOutQuart'
      },
      interaction: {
        mode: 'index',
        intersect: false
      },
      plugins: {
        legend: {
          display: true,
          position: 'top',
          labels: {
            color: 'rgba(255, 255, 255, 0.9)',
            font: {
              size: 14,
              weight: '600'
            },
            padding: 15,
            usePointStyle: true,
            pointStyle: 'circle'
          }
        },
        tooltip: {
          backgroundColor: 'rgba(15, 23, 42, 0.9)',
          titleColor: '#a855f7',
          bodyColor: '#fff',
          borderColor: 'rgba(168, 85, 247, 0.5)',
          borderWidth: 1,
          padding: 12,
          displayColors: true,
          callbacks: {
            label: function(context) {
              return context.dataset.label + ': ' + context.parsed.y.toLocaleString() + ' IOPS';
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          grid: {
            color: 'rgba(255, 255, 255, 0.05)',
            drawBorder: false
          },
          ticks: {
            color: 'rgba(255, 255, 255, 0.7)',
            font: { size: 12 },
            callback: function(value) {
              return value.toLocaleString();
            }
          },
          title: {
            display: true,
            text: 'IOPS',
            color: '#a855f7',
            font: { size: 14, weight: '600' }
          }
        },
        x: {
          grid: {
            color: 'rgba(255, 255, 255, 0.05)',
            drawBorder: false
          },
          ticks: {
            color: 'rgba(255, 255, 255, 0.7)',
            font: { size: 12 }
          },
          title: {
            display: true,
            text: 'Number of VMs',
            color: '#a855f7',
            font: { size: 14, weight: '600' }
          }
        }
      }
    };

    // Initialize chart
    const bwCtx = document.getElementById('bwChart').getContext('2d');
    bwChart = new Chart(bwCtx, {
      type: 'line',
      data: { 
        labels: [], 
        datasets: []
      },
      options: chartOptions
    });

    function getOrCreateDataset(chart, machineId, label) {
      let dataset = chart.data.datasets.find(ds => ds.label === machineId);
      
      if (!dataset) {
        const colorIndex = chart.data.datasets.length % chartColors.length;
        const colors = chartColors[colorIndex];
        
        dataset = {
          label: machineId,
          data: [],
          borderColor: colors.border,
          backgroundColor: colors.bg,
          borderWidth: 3,
          pointRadius: 6,
          pointHoverRadius: 8,
          pointBackgroundColor: colors.border,
          pointBorderColor: '#fff',
          pointBorderWidth: 2,
          tension: 0.3,
          fill: true
        };
        
        chart.data.datasets.push(dataset);
      }
      
      return dataset;
    }

    function updateStatus(message, status) {
      const statusEl = document.getElementById('status');
      const statusText = document.getElementById('statusText');
      const indicator = statusEl.querySelector('.status-indicator');
      
      statusText.textContent = message;
      
      if (status === 'connected') {
        statusEl.classList.remove('disconnected');
        indicator.classList.remove('disconnected');
      } else {
        statusEl.classList.add('disconnected');
        indicator.classList.add('disconnected');
      }
    }

    function updateAgentList(agentList) {
      agents = agentList;
      const container = document.getElementById('agentList');
      
      if (agentList.length === 0) {
        container.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: rgba(255,255,255,0.5); padding: 20px;">No agents connected</div>';
        return;
      }
      
      container.innerHTML = agentList.map(agent => `
        <div class="agent-card">
          <div class="agent-icon">üñ•Ô∏è</div>
          <div class="agent-name">${agent}</div>
          <div class="agent-status">Ready</div>
        </div>
      `).join('');
    }

    function connectWebSocket() {
      const host = window.location.host;
      const wsUrl = `ws://${host}/ws`;
      
      console.log('Connecting to:', wsUrl);
      
      ws = new WebSocket(wsUrl);
      
      ws.onopen = () => {
        updateStatus('Connected - Ready to run', 'connected');
        console.log('WebSocket connected');
      };
      
      ws.onmessage = (event) => {
        console.log('[DASHBOARD] Received message:', event.data);
        try {
          const msg = JSON.parse(event.data);
          console.log('[DASHBOARD] Parsed message:', msg);
          
          if (msg.type === 'agent_list') {
            updateAgentList(msg.agents);
            return;
          }
          
          if (msg.error) {
            console.warn('Received error:', msg.error);
            return;
          }
          
          if (msg.type === 'ping') {
            return;
          }
          
          const kpiValue = msg.requests || msg.bandwidth || msg.kpi;
          if (!kpiValue) {
            console.log('[DASHBOARD] Skipping message - no KPI value:', msg);
            return;
          }
          
          const machineId = msg.machine || msg.host || 'unknown';
          const coresOrVMs = msg.cores || msg.vms || '?';
          
          console.log('[DASHBOARD] Adding data point:', { machineId, coresOrVMs, kpi: kpiValue });
          
          testCount++;
          
          if (!bwChart.data.labels.includes(coresOrVMs)) {
            bwChart.data.labels.push(coresOrVMs);
            bwChart.data.labels.sort((a, b) => {
              const numA = parseInt(a) || 0;
              const numB = parseInt(b) || 0;
              return numA - numB;
            });
          }

          const bwDataset = getOrCreateDataset(bwChart, machineId, 'IOPS');
          
          const labelIndex = bwChart.data.labels.indexOf(coresOrVMs);
          
          while (bwDataset.data.length <= labelIndex) {
            bwDataset.data.push(null);
          }
          bwDataset.data[labelIndex] = kpiValue;
          
          bwChart.update('active');
          
          updateStatus(`Running - ${machineId}: ${msg.cores || msg.vms || '?'} VMs`, 'connected');
        } catch (e) {
          console.error('Error parsing message:', e);
        }
      };
      
      ws.onerror = (error) => {
        console.error('WebSocket error:', error);
        updateStatus('Connection error', 'disconnected');
      };
      
      ws.onclose = () => {
        console.log('WebSocket closed');
        updateStatus('Disconnected - Reconnecting...', 'disconnected');
        setTimeout(connectWebSocket, 3000);
      };
    }

    function connectControlChannel() {
      const host = window.location.host;
      const wsUrl = `ws://${host}/ws/control`;
      
      console.log('Connecting control channel to:', wsUrl);
      
      controlWs = new WebSocket(wsUrl);
      
      controlWs.onopen = () => {
        console.log('Control WebSocket connected');
        controlWs.send(JSON.stringify({ command: 'get_agents' }));
      };
      
      controlWs.onmessage = (event) => {
        const msg = JSON.parse(event.data);
        if (msg.type === 'agent_list') {
          updateAgentList(msg.agents);
        }
      };
      
      controlWs.onclose = () => {
        console.log('Control WebSocket closed');
        setTimeout(connectControlChannel, 3000);
      };
    }

    function runAll() {
      if (!controlWs || controlWs.readyState !== WebSocket.OPEN) {
        alert('Control connection not ready');
        return;
      }
      
      console.log('Triggering benchmark on all agents:', agents);
      
      const btn = document.getElementById('runAllBtn');
      btn.disabled = true;
      btn.innerHTML = '<div class="loading"></div> Running...';
      
      controlWs.send(JSON.stringify({
        command: 'run_all'
      }));
      
      setTimeout(() => {
        btn.disabled = false;
        btn.innerHTML = 'üî• Run All Agents';
      }, 3000);
    }

    // Initialize connections
    connectWebSocket();
    connectControlChannel();
  </script>
</body>
</html>

